---
title: "01.21.2026 Create Datasets from Traces with Span Associations"
---

<CardGroup cols={2}>
  <Card title="Python Client Reference" icon="python" href="/docs/phoenix/sdk-api-reference/python/arizeai-phoenix-client">
    Phoenix Client Documentation
  </Card>
  <Card title="Example Code" icon="github" href="https://github.com/Arize-ai/phoenix/blob/main/packages/phoenix-client/examples/datasets/create_dataset_from_spans_example.py">
    View on GitHub
  </Card>
</CardGroup>

## Overview

**Available in arize-phoenix-client 1.28.0+ (Python) and @arizeai/phoenix-client 2.0.0+ (TypeScript)**

Create datasets directly from production traces with bidirectional links between dataset examples and their source spans. Query spans using filters, transform the data, and create datasets that maintain connections to the original traces.

```mermaid
flowchart LR
    A[Production Traces] -->|1. Query spans| B[Filtered Spans]
    B -->|2. Transform data| C[Dataset Examples]
    C -->|3. Create dataset| D[Dataset]
    D -.->|Linked to source| A

    style D fill:#e1f5ff
    style A fill:#fff4e6
```

## Basic Usage

<CodeGroup>
```python Python
from phoenix.client import Client
from datetime import datetime, timedelta, timezone

client = Client()

# 1. Query spans from traces
spans_df = client.spans.get_spans_dataframe(
    project_identifier="my-project",
    start_time=datetime.now(timezone.utc) - timedelta(days=7),
)

# 2. Transform data
prepared_df = prepare_dataset_from_spans_df(spans_df)

# 3. Create dataset with span associations
dataset = client.datasets.create_dataset(
    name="my-dataset",
    dataframe=prepared_df,
    input_keys=["question"],
    output_keys=["answer"],
    span_id_key="context.span_id",  # Links examples to source spans
)
```

```typescript TypeScript
import { createClient, getSpans, createDataset } from "@arizeai/phoenix-client";

const client = createClient();

// 1. Query spans from traces
const { spans } = await getSpans({
  client,
  project: { projectName: "my-project" },
  startTime: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
  limit: 100,
});

// 2. Transform data
const preparedExamples = prepareExamples(spans);

// 3. Create dataset with span associations
const { datasetId } = await createDataset({
  client,
  name: "my-dataset",
  description: "Dataset from production traces",
  examples: preparedExamples.map((ex) => ({
    input: { question: ex.question },
    output: { answer: ex.answer },
    spanId: ex.spanId, // Links examples to source spans
  })),
});
```
</CodeGroup>

## Filtering Spans

Use queries to select specific spans based on attributes, status, or OpenInference metadata.

<CodeGroup>
```python Python
from phoenix.client.types import SpanQuery

# Query spans by status or token count
query = SpanQuery().where('status_code = "ERROR" or attributes."llm.token_count.total" > 8000')
spans_df = client.spans.get_spans_dataframe(
    project_identifier="my-project",
    query=query,
    start_time=datetime.now(timezone.utc) - timedelta(days=30),
)

# Query spans by session
query = SpanQuery().where('attributes."session.id" = "abc123"')
spans_df = client.spans.get_spans_dataframe(
    project_identifier="my-project",
    query=query,
)

# Query spans by model
query = SpanQuery().where('attributes."llm.model_name" = "gpt-4"')
spans_df = client.spans.get_spans_dataframe(
    project_identifier="my-project",
    query=query,
)
```

```typescript TypeScript
// Note: TypeScript client does not support query filters yet
// Filter spans after retrieval
const { spans } = await getSpans({
  client,
  project: { projectName: "my-project" },
  startTime: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000),
  limit: 1000,
});

// Filter by status
const errorSpans = spans.filter(span => span.status_code === "ERROR");

// Filter by session
const sessionSpans = spans.filter(span =>
  span.attributes?.["session.id"] === "abc123"
);

// Filter by model
const gpt4Spans = spans.filter(span =>
  span.attributes?.["llm.model_name"] === "gpt-4"
);
```
</CodeGroup>

## Data Preparation

Transform span data into the format needed for your dataset.

<CodeGroup>
```python Python
import json
import pandas as pd

def prepare_dataset_from_spans_df(spans_df: pd.DataFrame) -> pd.DataFrame:
    df = spans_df.copy()

    # Ensure span_id is a column, not the index
    if df.index.name == "context.span_id":
        df = df.reset_index()

    # Parse JSON-encoded input/output values
    inputs = df["attributes.input.value"].apply(json.loads)
    outputs = df["attributes.output.value"].apply(json.loads)

    # Extract fields
    return pd.DataFrame({
        "context.span_id": df["context.span_id"],
        "question": inputs.apply(lambda x: x.get("question")),
        "answer": outputs.apply(lambda x: x.get("answer")),
    })
```

```typescript TypeScript
function prepareExamples(spans: Span[]) {
  return spans.map((span) => {
    const input = typeof span.input === "string"
      ? JSON.parse(span.input)
      : span.input;
    const output = typeof span.output === "string"
      ? JSON.parse(span.output)
      : span.output;

    return {
      spanId: span.spanId,
      question: input.question,
      answer: output.answer,
    };
  });
}
```
</CodeGroup>

### Linking to Source Spans

**Python**: Use `span_id_key` to specify which column contains span IDs.

**TypeScript**: Use `spanId` field in each example object.

Phoenix validates that span IDs exist and creates bidirectional links visible in the UI.

## Complete Example

See the full example in the phoenix-client repository: [`create_dataset_from_spans_example.py`](https://github.com/Arize-ai/phoenix/blob/main/packages/phoenix-client/examples/datasets/create_dataset_from_spans_example.py)

## Requirements

- Phoenix server running (local or hosted)
- Existing traces with LLM spans
- **Python**: `arize-phoenix-client` 1.28.0 or later
- **TypeScript**: `@arizeai/phoenix-client` 2.0.0 or later

<CodeGroup>
```bash Python
pip install arize-phoenix-client>=1.28.0
```

```bash TypeScript
npm install @arizeai/phoenix-client
# or
pnpm add @arizeai/phoenix-client
```
</CodeGroup>

## Feedback

Share feedback or report issues on [GitHub](https://github.com/Arize-ai/phoenix).
