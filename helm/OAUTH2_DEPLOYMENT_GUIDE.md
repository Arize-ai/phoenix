# OAuth2/OIDC Deployment Guide

This guide explains how to deploy Phoenix with OAuth2/OIDC authentication using the Helm chart.

## Overview

Phoenix supports authentication via OAuth2 identity providers (IDPs) using OpenID Connect (OIDC). This allows users to authenticate using external identity providers like Google, AWS Cognito, Microsoft Entra ID, and others.

## Prerequisites

1. A Kubernetes cluster with Helm installed
2. An OAuth2 application registered with your identity provider
3. The following information from your IDP:
   - Client ID
   - Client Secret
   - OIDC Configuration URL

## Quick Start

### 1. Create a values file

Create a `values.yaml` file with your OAuth2 configuration:

```yaml
auth:
  enableAuth: true
  oauth2:
    enabled: true
    providers:
      google:
        client_id: "your-google-client-id"
        client_secret: "your-google-client-secret"
        oidc_config_url: "https://accounts.google.com/.well-known/openid-configuration"
        display_name: "Google"
        allow_sign_up: true
        auto_login: false
```

### 2. Deploy Phoenix

```bash
helm install phoenix . -f values.yaml
```

## Configuration Options

### Provider Configuration

Each OAuth2 provider supports the following configuration options:

| Option | Required | Default | Description |
|--------|----------|---------|-------------|
| `client_id` | Yes | - | The client ID generated by the IDP when registering the application |
| `client_secret` | Yes | - | The client secret generated by the IDP when registering the application |
| `oidc_config_url` | Yes | - | The URL to the OpenID Connect well-known configuration endpoint |
| `display_name` | No | Provider name | A user-friendly name for the identity provider |
| `allow_sign_up` | No | `true` | Whether to allow new user registration |
| `auto_login` | No | `false` | Whether to enable auto-login for this provider |

### Multiple Providers

You can configure multiple OAuth2 providers simultaneously:

```yaml
auth:
  oauth2:
    enabled: true
    providers:
      google:
        client_id: "your-google-client-id"
        client_secret: "your-google-client-secret"
        oidc_config_url: "https://accounts.google.com/.well-known/openid-configuration"
        display_name: "Google"
      
      aws_cognito:
        client_id: "your-aws-cognito-client-id"
        client_secret: "your-aws-cognito-client-secret"
        oidc_config_url: "https://cognito-idp.us-east-1.amazonaws.com/us-east-1_xxxxx/.well-known/openid-configuration"
        display_name: "AWS Cognito"
```

## Identity Provider Setup

### Google OAuth2

1. Go to the [Google Cloud Console](https://console.cloud.google.com/)
2. Select your project and navigate to "APIs & Services" > "Credentials"
3. Click "Create Credentials" > "OAuth client ID"
4. Choose "Web application" as the application type
5. Add your Phoenix URL to "Authorized JavaScript origins"
6. Add your Phoenix callback URL to "Authorized redirect URIs": `https://your-domain.com/oauth2/google/tokens`
7. Copy the client ID and client secret

### AWS Cognito

1. Go to the AWS Management Console and navigate to Cognito
2. Create a new User Pool or use an existing one
3. Create a new App Client with "Confidential client" type
4. Enable "Generate client secret"
5. Configure the callback URL: `https://your-domain.com/oauth2/aws_cognito/tokens`
6. Copy the client ID, client secret, and user pool ID
7. Construct the OIDC config URL: `https://cognito-idp.<region>.amazonaws.com/<user-pool-id>/.well-known/openid-configuration`

### Microsoft Entra ID

1. Go to the Azure Portal and navigate to "Microsoft Entra ID"
2. Go to "App registrations" and click "New registration"
3. Enter a name for your application
4. Set the redirect URI to: `https://your-domain.com/oauth2/microsoft_entra_id/tokens`
5. Copy the Application (client) ID
6. Create a client secret under "Certificates & secrets"
7. Copy the OIDC metadata document URL from "Endpoints"

### Keycloak

1. Log into your Keycloak admin console
2. Create a new realm or use an existing one
3. Go to "Clients" and create a new client
4. Set the client ID to "phoenix"
5. Set the root URL to your Phoenix domain
6. Add the redirect URI: `https://your-domain.com/oauth2/keycloak/tokens`
7. Enable "Client authentication"
8. Copy the client secret from the "Credentials" tab
9. Construct the OIDC config URL: `https://your-keycloak-server/realms/your-realm/.well-known/openid-configuration`

## Security Considerations

### HTTPS Required

OIDC configuration URLs must use HTTPS (except for localhost). Ensure your Phoenix deployment is accessible via HTTPS.

### CORS and CSRF Configuration

Configure appropriate CORS origins and CSRF trusted origins:

```yaml
auth:
  allowedOrigins:
    - "https://your-phoenix-domain.com"
  csrfTrustedOrigins:
    - "https://your-phoenix-domain.com"
```

### Secure Cookies

Enable secure cookies when using HTTPS:

```yaml
auth:
  useSecureCookies: true
```

### Client Secret Security

Client secrets are automatically stored in Kubernetes secrets and are never exposed in configmaps or logs.

## Troubleshooting

### Common Issues

1. **"Invalid redirect URI" error**: Ensure the redirect URI in your IDP configuration matches exactly: `https://your-domain.com/oauth2/<provider>/tokens`

2. **"HTTPS required" error**: Ensure your OIDC configuration URL uses HTTPS (except for localhost)

3. **"Client not found" error**: Verify your client ID and client secret are correct

4. **"Configuration URL not accessible" error**: Test your OIDC configuration URL in a browser to ensure it's accessible

### Debugging

To debug OAuth2 issues:

1. Check the Phoenix logs for authentication errors
2. Verify your OIDC configuration URL returns valid JSON
3. Ensure your IDP is configured to allow the Phoenix redirect URI
4. Check that your client secret is correctly set in the Kubernetes secret

### Testing

You can test your OIDC configuration by:

1. Deploying Phoenix with your OAuth2 configuration
2. Navigating to the Phoenix login page
3. Clicking on your configured OAuth2 provider
4. Completing the authentication flow

## Example Deployments

See the following example files for complete deployment configurations:

- `example-oauth2-values.yaml` - Comprehensive example with multiple providers
- `test-oauth2-values.yaml` - Simple test configuration

## Additional Resources

- [Phoenix Authentication Documentation](https://arize.com/docs/phoenix/self-hosting/authentication)
- [OpenID Connect Specification](https://openid.net/connect/)
- [OAuth 2.0 Specification](https://oauth.net/2/)