name: Python CI

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - "**.py"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency:
  group: test-python-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  code-format:
    name: Code Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: 3.8
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hatch
      - name: Check format
        run: |
          hatch run style:check

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: 3.8
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hatch
      - name: Test coverage
        run: |
          hatch run coverage

  docs-coverage:
    name: Test Documentation Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: 3.8
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hatch
      - name: Check format
        run: |
          hatch run docs:check


  test:
    name: Test Python
    runs-on: ${{ matrix.os }}
    needs: [ code-format, test-coverage, docs-coverage ]
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        python-version: [ "3.8", "3.9", "3.10", "3.11" ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hatch
      - name: Run tests
        run: |
          hatch run tests


#  Error: Advanced Security must be enabled for this repository to use code scanning.
#
#  code-ql:
#    name: CodeQL Analysis
#    # CodeQL runs on ubuntu-latest, windows-latest, and macos-latest
#    runs-on: ubuntu-latest
#    needs: [dep-review, documentation, code-format]
#    permissions:
#      # required for all workflows
#      security-events: write
#      # only required for workflows in private repositories
#      actions: read
#      contents: read
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#      # Initializes the CodeQL tools for scanning.
#      - name: Initialize CodeQL
#        uses: github/codeql-action/init@v2
#      # Autobuild attempts to build any compiled languages (C/C++, C#, or Java).
#      # If this step fails, then you should remove it and run the build manually (see below).
#      - name: Autobuild
#        uses: github/codeql-action/autobuild@v2
#      - name: Perform CodeQL Analysis
#        uses: github/codeql-action/analyze@v2
#
#  Error: Dependency review is not supported on this repository. Please ensure that Dependency graph is enabled,
#  see https://github.com/Arize-ai/arize-toolbox/settings/security_analysis
#
#  dep-review:
#    name: Dependency Review
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#    steps:
#      - name: Check out Git repository
#        uses: actions/checkout@v3
#      - name: Dependency Review
#        uses: actions/dependency-review-action@v1

#  TODO(Kiko): Improve this GitHub Action
#  documentation:
#    name: Docstring Coverage
#    runs-on: ubuntu-latest
#    steps:
#    - name: Checkout
#      uses: actions/checkout@v3
#    - name: Set up Python 3.8
#      uses: actions/setup-python@v3
#      with:
#        python-version: 3.8
#    - name: Python Interrogate Check
#      uses: JackMcKew/python-interrogate-check@main
#      with:
#        path: 'phoenix'
#        fail-under: 90

